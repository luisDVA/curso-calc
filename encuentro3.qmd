---
title: "R para el tratamiento de Hojas de Cálculo"
subtitle: "Tercer encuentro: Archivos en la nube y formato"
date: "25 de Noviembre, 2025"
author: "Luis D. Verde Arregoitia"
format:
  revealjs:
    slide-number: true
    theme: css/slides.scss
editor: visual
---

## Resumen del encuentro anterior

- Listas e iteración en R
- Trabajo con múltiples archivos o pestañas
- Exportación de datos a Excel
- Operaciones comunes con dataframes

## Objetivos de hoy

- Conectar R con Google Sheets
- Leer y escribir datos en hojas de cálculo en la nube
- Trabajar con formato de celdas
- Importar hojas con formato conservando su estructura

## Trabajo con archivos en la nube (Google Sheets)

### Ventajas

- Acceso desde cualquier dispositivo
- Colaboración en tiempo real
- Control de versiones
- Integración con otros servicios de Google
- Automatización de tareas

## Inicio de sesión y conexión con la API de Google

### Instalación de paquetes necesarios

```{r}
#| eval: false
#| echo: true
# Instalar paquetes
install.packages(c("googlesheets4", "googledrive"))

# Cargar paquetes
library(googlesheets4)
library(googledrive)
```

## Autenticación con Google

```{r}
#| eval: false
#| echo: true
# Autenticación con interacción del usuario
gs4_auth()
drive_auth()

# También es posible autenticar con un archivo de credenciales
gs4_auth(path = "tu_archivo_credenciales.json")

# O usar un token guardado previamente
gs4_auth(token = "token.rds")
```

## Accediendo a hojas de Google Sheets

```{r}
#| eval: false
#| echo: true
# Listar hojas de cálculo disponibles
mis_sheets <- gs4_find()

# Acceder por URL
datos <- read_sheet("https://docs.google.com/spreadsheets/d/abc123...")

# Acceder por ID
id_sheet <- "abc123..."
datos <- read_sheet(id_sheet)

# Acceder a una hoja específica
datos <- read_sheet(id_sheet, sheet = "Ventas")
```

## Trabajando con pestañas específicas

```{r}
#| eval: false
#| echo: true
# Obtener nombres de las pestañas
sheet_names <- sheet_names(id_sheet)

# Leer múltiples pestañas
all_sheets <- sheet_names %>%
  purrr::set_names() %>%
  purrr::map(~read_sheet(id_sheet, sheet = .x))

# Leer rangos específicos
datos_rango <- read_sheet(id_sheet, 
                         sheet = "Ventas",
                         range = "A1:D20")
```

## Escribiendo datos a Google Sheets

```{r}
#| eval: false
#| echo: true
# Crear una nueva hoja de cálculo
nuevo_sheet <- gs4_create("Nuevo análisis")

# Escribir datos a una hoja existente
write_sheet(datos, ss = id_sheet, sheet = "Nueva pestaña")

# Actualizar datos existentes
sheet_write(datos_actualizados, 
            ss = id_sheet, 
            sheet = "Datos")
```

## Archivos en Sheets y Drive

```{r}
#| eval: false
#| echo: true
# Listar archivos en Drive
mis_archivos <- drive_find(type = "spreadsheet")

# Buscar un archivo específico
archivo <- drive_find(pattern = "Ventas 2025")

# Descargar un archivo
drive_download(archivo, path = "ventas_local.xlsx")

# Compartir un archivo
drive_share(archivo, role = "reader", 
            type = "anyone", emailAddress = "usuario@example.com")
```

## Integración de Sheets con dplyr

```{r}
#| eval: false
#| echo: true
library(dplyr)

# Leer datos de Google Sheets
datos_ventas <- read_sheet(id_sheet, sheet = "Ventas")

# Aplicar operaciones dplyr
resultados <- datos_ventas %>%
  filter(region == "Norte") %>%
  group_by(producto) %>%
  summarize(total_ventas = sum(ventas, na.rm = TRUE)) %>%
  arrange(desc(total_ventas))

# Escribir resultados de vuelta a Google Sheets
write_sheet(resultados, ss = id_sheet, sheet = "Resultados")
```

## Trabajando con formato en celdas o texto

### Desafíos comunes con formato

- Colores de fondo o texto que representan información
- Celdas combinadas
- Alineación específica de datos
- Fuentes o tamaños de texto significativos
- Bordes que denotan agrupaciones

## Importando hojas con formato

El paquete `openxlsx` permite conservar y manipular formato:

```{r}
#| eval: false
#| echo: true
library(openxlsx)

# Leer un archivo Excel preservando el formato
wb <- loadWorkbook("datos_con_formato.xlsx")

# Obtener hojas disponibles
sheets <- getSheetNames("datos_con_formato.xlsx")

# Leer una hoja específica como dataframe
datos <- read.xlsx(wb, sheet = 1)
```

## Detectando celdas con formato en Excel

```{r}
#| eval: false
#| echo: true
# Obtener información de estilo de celda
estilos <- getStyles(wb)

# Verificar celdas con formato específico
celdas_rojas <- getCellStyle(wb, sheet = 1, rows = 1:10, cols = 1:5)

# Identificar celdas con fondo rojo (para análisis posterior)
for (i in 1:length(celdas_rojas)) {
  if (!is.null(celdas_rojas[[i]]$fill$fillFg) && 
      celdas_rojas[[i]]$fill$fillFg == "#FF0000") {
    # Procesar estas celdas de forma especial
    print(paste("Celda con fondo rojo encontrada en posición:", i))
  }
}
```

## Creando informes con formato personalizado

```{r}
#| eval: false
#| echo: true
# Crear un libro de trabajo
wb <- createWorkbook()
addWorksheet(wb, "Informe")

# Escribir datos
writeData(wb, "Informe", datos)

# Definir estilos
estilo_encabezado <- createStyle(
  fontColour = "#FFFFFF", fontSize = 12,
  fgFill = "#8BC34A", textDecoration = "bold",
  halign = "center", border = "TopBottom"
)

estilo_numerico <- createStyle(
  numFmt = "#,##0.00", 
  halign = "right"
)

# Aplicar estilos
addStyle(wb, "Informe", estilo_encabezado, 
         rows = 1, cols = 1:ncol(datos))

# Aplicar formato condicional
conditionalFormatting(wb, "Informe", 
                     cols = 3, 
                     rows = 2:(nrow(datos) + 1),
                     rule = "$C2>1000", 
                     style = createStyle(fgFill = "#AED581"))
```

## Extrayendo información de celdas con formato

```{r}
#| eval: false
#| echo: true
library(tidyxl)
library(unpivotr)

# Importar Excel preservando formato
celdas <- xlsx_cells("datos_con_formato.xlsx", sheets = "Hoja1")

# Examinar celdas con formato específico
celdas_con_color <- celdas %>%
  filter(!is.na(fill_color))

# Extraer datos estructurados de celdas con formato
datos_estructurados <- celdas %>%
  filter(row >= 5, col >= 3, col <= 7) %>%
  select(row, col, character, numeric, formula, is_blank) %>%
  behead("up", header) %>%
  behead("left", categoria)
```

## Generando informes con estilo consistente

```{r}
#| eval: false
#| echo: true
# Función para aplicar un estilo consistente a informes
crear_informe_estilo <- function(datos, nombre_archivo) {
  wb <- createWorkbook()
  addWorksheet(wb, "Informe")
  
  writeData(wb, "Informe", datos)
  
  # Aplicar estilos corporativos
  addStyle(wb, "Informe", estilo_corporativo_header(), 
           rows = 1, cols = 1:ncol(datos))
  
  # Ajustar ancho de columnas
  setColWidths(wb, "Informe", cols = 1:ncol(datos), 
               widths = "auto")
  
  # Guardar archivo
  saveWorkbook(wb, nombre_archivo, overwrite = TRUE)
}
```

## Para el próximo encuentro...

- Resolveremos problemas comunes con hojas de cálculo:
  - Manejo de fechas
  - Encabezados problemáticos
  - Disposiciones irregulares de datos
- Analizaremos ejemplos reales
- Discutiremos recursos útiles y mejores prácticas

### Ejercicio sugerido
Conecten R con una hoja de Google Sheets y practiquen la lectura/escritura de datos.