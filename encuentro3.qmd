---
title: "R para el tratamiento de Hojas de Cálculo"
subtitle: "Tercer encuentro: Archivos en la nube y formato"
date: "11/25/2025"
author: "Luis D. Verde Arregoitia"
format:
  revealjs:
    slide-number: true
    theme: css/slides.scss
editor: visual
---


## Resumen del encuentro anterior
-   Pipes
-   Listas e iteración en R
-   Trabajo con múltiples archivos o pestañas
-   Exportando objetos

## Objetivos de hoy

-   Operaciones comunes con dataframes
-   Conectar R con Google Sheets
-   Leer y escribir datos en hojas de cálculo en la nube
-   Trabajar con formato de celdas
-   Importar hojas con formato conservando su estructura

## Trabajo con archivos en la nube

-   Acceso desde cualquier máquina
-   Colaboración en tiempo real
-   Control de versiones
-   Integración con otros servicios de Google (en caso de Google Sheets)

## Paquetes para hoy

:::: columns
::: {.column width="50%"}
![](https://googlesheets4.tidyverse.org/logo.png){width="100"}

- `googlesheets4`
:::

::: {.column width="50%"}
![](https://googledrive.tidyverse.org/logo.png){width="100"}

- `googledrive`
:::
::::


## Solo lectura, archivos públicos

Para acceder a recursos públicos en modalidad solo lectura, usamos `gs4_deauth()` (sin argumentos). 

<br/>

```{r}
#| eval: false
#| echo: true

library(googlesheets4)
gs4_deauth()
```


## Imporando hojas con googlesheets4

Usamos `read_sheet()` y nos referimos a los archivos por URL o ID.
<br/>
```{r}
#| eval: false
#| echo: true

library(googlesheets4)
read_sheet("https://docs.google.com/spreadsheets/d/1iuFDsNK3VHysX0zja3NpNb_f3xK3ny5Y_BlO9XuIZRQ/edit?usp=sharing"
)
read_sheet("1iuFDsNK3VHysX0zja3NpNb_f3xK3ny5Y_BlO9XuIZRQ")
```


## Ejercicio - Traslados {background="#fff0f3"} 

Importa este archivo público de Google Sheets que contiene datos de traslados durante un congreso, el ID es:  
`1v38NIbOj9wAMBmB8MYLIczQjsblrc1g5Ns3ssa05owE`  

<br/>

_¿Hay alguna columna que nos gustaría modificar para mejorar la estructura de los datos?_

## Inició de sesión con Google

Para poder trabajar con archivos privados y/o modificar las hojas, necesitamos una cuenta de Google para iniciar sesión.

<br/>
```{r}
#| eval: false
#| echo: true
# Autenticación interactiva
gs4_auth()
drive_auth()

```

También podemos usar un archivo de credenciales o tokens existentes  
`gs4_auth(path = "tu_archivo_credenciales.json")`  
`gs4_auth(token = "token.rds")`


## Accediendo a hojas de Google Sheets

```{r}
#| eval: false
#| echo: true
# Lista de hojas de cálculo disponibles
mis_sheets <- gs4_find()
```

## Trabajando con hojas/pestañas específicas

```{r}
#| eval: false
#| echo: true
# Obtener nombres de las pestañas
sheet_names <- sheet_names(id_sheet)

# Leer múltiples pestañas
sheet_names %>%
  purrr::set_names() %>%
  purrr::map(\(x) read_sheet(id_sheet, sheet = x))
```

También podemos usar el argumento `range` para leer rangos específicos (ej, "A1:D20") 

## Ejercicio - Múltiples Hojas {background="#fff0f3"} 

Importar todas las hojas de este Google Sheets, el ID es:  

`1E01TbbwZ4S_RWX5RhkrjKXuyRG1EvT5Iog9QHuhIoms`

## Escribiendo datos a Google Sheets

```{r}
#| eval: false
#| echo: true
# Crear una nueva hoja de cálculo
nuevo_sheet <- gs4_create("Nuevo análisis")

# Escribir datos a una hoja existente
write_sheet(datos, 
            ss = identificador, 
            sheet = "Nueva pestaña")

```

## Archivos en Sheets y Drive

```{r}
#| eval: false
#| echo: true
# Listar archivos en Drive
mis_archivos <- drive_find(type = "spreadsheet")

# Buscar un archivo específico
archivo <- drive_find(pattern = "Ventas 2025")
```

## Archivos en Sheets y Drive

```{r}
#| eval: false
#| echo: true

# Descargar un archivo
drive_download(archivo, path = "ventas_local.xlsx")

# Compartir un archivo
drive_share(archivo, role = "reader", 
            type = "anyone", 
            emailAddress = "usuario@example.com")
```


# Trabajando con formato en celdas o texto

## ¿Formato?

-   Colores de fondo o texto **que representan información**
-   Celdas combinadas
-   Alineación específica de datos
-   Fuentes o tamaños de texto **significativos**
-   Bordes que denotan agrupaciones

## 

Revisemos el archivo `gwater.xlsx`
<br/>
```{r}
#| eval: true
#| echo: true

readxl::read_excel("hojs/gwater.xlsx")
```

## Datos críticos de agua subterránea municipal

```{r}
#| eval: true
#| echo: false
library(gt)
```
```{r}
#| eval: true
#| echo: false

forgts::forgts("hojs/gwater.xlsx") |> 
  tab_footnote(
    footnote = "Valores negativos en negritas",
    locations = cells_column_labels(columns = 2)
  ) |> 
 tab_footnote(
     footnote = "Sitios aprobados en amarillo",
     locations = cells_column_labels(columns = 3)
   ) |> 
    tab_style(
    style = cell_borders(
      sides = "all",
      weight = px(1.5),
      style = "solid"
    ),
    locations = list(cells_body(),cells_column_labels())
  ) |> 
  opt_table_font(size=36)

```


## Veterinaria

```{r}

forgts::forgts("hojs/pets.xlsx") |> 
  tab_footnote(
    footnote = "Negro = libras, Azul = kilos",
    locations = cells_column_labels(columns = 3)
  ) |> 
tab_footnote(
    footnote = "Naranja = falta revisar",
    locations = cells_column_labels(columns = 4)
  ) |> 
    tab_style(
    style = cell_borders(
      sides = "all",
      weight = px(1.5),
      style = "solid"
    ),
    locations = list(cells_body(),cells_column_labels())
  ) |> 
  
  opt_table_font(size=30)

```

##

```{r}
readxl::read_excel("hojs/pets.xlsx")
```

# Importando hojas con formato

##

::::: {.r-package}
::: {.r-package-content}
<h3 class="r-package-title">unheadr</h3>
<a href="https://unheadr.liomys.mx" class="r-package-link">Sitio official</a>
<br/>
<p class="r-package-description">
- Funciones para limpar datos

- Combina `readxl` y `tidyxl` para desenterrar los valores de formato en hojas de cálculo y los pega a los valores de celda

</p>
:::

![](images/unheadrlogo.png){.r-package-logo}
::::


## Desenmascarando el formato
 
:::: columns
::: {.column width="30%"}
![](images/scoobyxl.png){width="80%"}
:::
::: {.column width="70%"}
- El formato en una hoja de cálculo puede contener información valiosa que no se captura al importar los datos como un data frame tradicional.

- Cambiemos la extensión de alguna hoja con formato a .zip y exploremos su contenido.
:::
::::


## Ejemplo caracoles

![](images/snailsheetsmol.png)

. . .

:::: columns
::: {.column width="70%"}

> "los días de muestreo se indican en amarillo"

:::
::: {.column width="30%"}

![](images/snailsm.png)

:::
::::

##  Demostración unheadr {background="#fff0f3"} 

Importemos y procesemos los ejemplos de agua y mascotas usando unheadr


## Extrayendo información de celdas con formato
```{r}
#| eval: false
#| echo: true

library(tidyxl)
library(unpivotr)

# Importar Excel preservando formato
celdas <- xlsx_cells("hojs/pets.xlsx")

# Examinar celdas con formato específico (colores de fuente)
celdas_con_color <- celdas %>%
  filter(!is.na(font_color))

```

##

```{r}
#| eval: false
#| echo: true

# Extraer datos estructurados preservando información de formato
datos_con_formato <- celdas %>%
  filter(row >= 2, !is.na(character) | !is.na(numeric)) %>%
  select(row, col, character, numeric, font_color) %>%
  behead("up", "variable") %>%
  select(row, variable, character, numeric, font_color)
```

## Para el próximo encuentro...

-   Resolveremos problemas comunes con hojas de cálculo:
    -   Manejo de fechas
    -   Encabezados problemáticos
    -   Disposiciones irregulares de datos
-   Analizaremos ejemplos reales
-   Discutiremos recursos útiles y mejores prácticas

# !Gracias!

