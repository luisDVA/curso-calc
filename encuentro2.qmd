---
title: "R para el tratamiento de Hojas de C치lculo"
subtitle: "Segundo encuentro: Listas, iteraci칩n y c칩mo exportar tablas"
date: "11/18/2025"
author: "Luis D. Verde Arregoitia"
format:
  revealjs:
    slide-number: true
    theme: css/slides.scss
editor: visual
---

## Resumen del encuentro anterior

- Buenas pr치cticas para organizar datos
- Fundamentos de hojas de c치lculo
- Importando archivos 

## Hoy

- Listas & iteraci칩n para trabajar con m칰ltiples archivos
- Operaciones comunes de manipulaci칩n de datos
- Exportar objetos de R a hojas de c치lculo

## Hoy

Paquetes para el encuentro

- `purrr`
- `dplyr`
- `writexl`
- `fs`

# Listas & iteraci칩n

## Listas en R

Las listas son estructuras de datos vers치tiles que pueden guardar objetos de clases diferentes:

```{r}
#| eval: true
#| echo: true
# Crear una lista con diferentes tipos de datos
mi_lista <- list(
  numeros = 1:5,
  texto = "Estaci칩n R",
  logico = c(TRUE,TRUE,FALSE,TRUE),
  data = data.frame(x = 1:3, y = c("a", "b", "c"))
)

```


##

```{r}
#| eval: true
#| echo: true
mi_lista
```

## Accedediendo a los elementos de la lista

```{r}
#| eval: true
#| echo: true


mi_lista$numeros
mi_lista[["texto"]]
mi_lista[[4]]  
```

## Listas + hojas de c치lculo

- Almacenar m칰ltiples dataframes derivados de pesta침as/hojas
- Trabajar con m칰ltiples archivos en simult치neo
- Cada elemento de una lista puede tener nombre

## Ejercicio - Lista de tablas {background="#fff0f3"} 

Con el archivo `cafeteria.xlsx`:  

- Crear una lista con un elemento (data frame) para cada una de las dos primeras hojas (Bebidas y Panader칤a)
- Crear una carpeta nueva para salidas con `fs`
- Exportar cada elemento de la lista a un archivo de texto plano


## De data frame a archivo xlsx

El paquete `writexl` permite exportar data frames o listas de data frames a plantillas xlsx

<br/>

```{r}
#| echo: true
#| eval: false
library(writexl)
writexl::write_xlsx(x= "mi_tabla",
                    path="mipantilla.xlsx")
```

## `writexl`

Si usamos listas (incluso listas de longitud 1) los nombres de los elementos se usan como nombres de las pesta침as/hojas

<br/>

`write_xlsx(x=list(mi_hoja = mi_tabla))`

## Ejercicio - Exportando {background="#fff0f3"}

- Exportar cada elemento de la lista a su propio archivo xlsx
- Exportar la lista a un solo archivo con nombres para cada pesta침a
- 쮺칩mo cambiar칤amos los nombres de las pesta침as?

## Aplicando una funci칩n varias veces

Copiar/pegar c칩digo para editarlo en an치lisis repetitivos agrega pasos innecesarios, pierde tiempo, y aumenta el riesgo de introducir errores 

## Aplicando funciones a m칰ltiples elementos

Para: cada elemento de **x**  
Aplicar la funci칩n **f**

```{r}
#| eval: true
#| echo: true
for (x in 1:7){
  print(x)
} 
```

## 

`x` puede ser una lista o vector de rutas, y `f` una funci칩n para leer archivos

<br/>

```{r}
#| eval: false
#| echo: true
library(purrr)
library(fs)
archivos_csv <- dir_ls(glob = "*.csv")
todos <- map(archivos_csv, read.csv)

```


## purrr?

::: columns
::: {.column width="25%"}
![](images/purrr.jpeg)
:::

::: {.column width="75%"}
游닍 **`purrr`** - Herramientas para programaci칩n funcional

-   funciones `map` que aplican una funci칩n a cada elemento de una lista o vector y devuelve un resultado de la misma longitud que la entrada

-   trabaja bien con **listas**
-   c칩digo legible y conciso
:::
:::

::::{.rightref}
:::{.refbox}
Thomas Mock (2018)\
[Functional Programming in R with purrr](https://towardsdatascience.com/functional-programming-in-r-with-purrr-469e597d0229)
:::
:::


## Ejercicio - purrr para m칰ltiples archivos CSV {background="#fff0f3"}

- Usa el c칩digo de hace dos diapositivas para importar los archivos csv generados en el ejercicio anterior usando la funci칩n `map` de `purrr`.

- Combinemos las tablas en una sola

## Importando m칰ltiples pesta침as 

```{r}
#| eval: false
#| echo: true
# Leer todas las pesta침as de un archivo Excel
library(readxl)
pestanas <- excel_sheets("ejemplos/cafeteria.xlsx")
pestanas
# purrr
library(purrr)
map(pestanas, \(x) read_excel("ejemplos/cafeteria.xlsx", sheet = x))
```

> 쮺칩mo acotamos el proceso a las dos primeras hojas?

## Funciones an칩nimas, notaci칩n actual

**Funciones para llevar** (se crean y se ejecutan pero nunca se asignan a un objeto con nombre)

### Sintaxis

:::{.big-code}
```{r}
#| echo: true
#| eval: true
(\(x) x + 3)(10)
```
:::

La definici칩n va entre par칠ntesis para separar la funci칩n de sus argumentos

##


`map(pestanas, \(x) read_excel("ejemplos/cafeteria.xlsx", sheet = x))`

<br/>

equivale a 

`read_excel("ejemplos/cafeteria.xlslx", sheet="Bebidas")` luego  
`read_excel("ejemplos/cafeteria.xlslx", sheet="Panaderia")`  etc...

## Datos agrupados

La mayor칤a de nuestras tareas se pueden desarrollar siguiendo el paradigma "_dividir - aplicar - combinar_" (
["split-apply-combine"]{style="color: purple"}):

- dividir los datos en grupos
- aplicar alguna funci칩n a cada grupo
- combinar los resultados

::::{.rightref}
:::{.refbox}
Data Carpentry (2018)\
[Aggregating and analyzing data with dplyr](https://datacarpentry.org/R-genomics/04-dplyr.html)

Hadley Wickham (2011)\
[The split-apply-combine strategy for data analysis](https://doi.org/10.18637/jss.v040.i01)
:::
::::

## `dplyr::group_by()`

- Define grupos seg칰n una o m치s variables  
- Estratifica un data frame  
- equivalente a `aggregate()` y al argumento '`by =`' de `data.table`

![Manipulaci칩n de datos en R con dplyr - Rub칠n S치nchez](images/groupby.PNG){width="64%"}


## Trabajando con datos agrupados

Con la versi칩n agrupada de nuestra tabla, las funciones de `dplyr` trabajan sobre cada grupo por separado y despu칠s se combinan los resultados.

</br>

::::{.rightref}
:::{.refbox}
RStudio (2021)\
[Data transformation with dplyr cheatsheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-transformation.pdf)
:::
:::

## Opciones para datos agrupados

- resumir valores (media, mediana, etc. por grupo)
- extraer las primeras o 칰ltimas _n_ filas por grupo
- identificar valores m치ximos o m칤nimos
- eliminar filas repetidas
- contar observaciones, etc.


## Dividir datos en pesta침as o archivos separados

```{r}
#| eval: false
#| echo: true
# Dividir un dataframe por una variable categ칩rica
chatarra <- read_excel("ejemplos/fastfood.xls")
chatarra |> group_by(restaurant) |> group_split()
```


## Para el pr칩ximo encuentro...

- Trabajaremos con archivos en la nube (Google Sheets)
- Aprenderemos a conectarnos con la API de Google
- Veremos c칩mo trabajar con formato en celdas o texto

