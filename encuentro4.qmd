---
title: "R para el tratamiento de Hojas de C치lculo"
subtitle: "Cuarto encuentro: Problemas comunes y ejemplos pr치cticos"
date: "02/12/2025"
author: "Luis D. Verde Arregoitia"
format:
  revealjs:
    slide-number: true
    theme: css/slides.scss
editor: visual
---

## Resumen del curso hasta ahora

- Introducci칩n a hojas de c치lculo y buenas pr치cticas
- Listas e iteraci칩n para trabajar con m칰ltiples archivos
- Importar y exportar de datos
- Trabajo con archivos en la nube
- Archivos con formato de celda

## Objetivos de hoy

- Resolver problemas comunes con hojas de c치lculo
- Limpiar ejemplos reales

## Paquetes para hoy

- `janitor`: Limpieza de datos
- `lubridate`: Manejo de fechas
- `tidyr`: Transformaci칩n de datos
- `dplyr`: Manipulaci칩n de datos
- `unheadr`: Manejo de encabezados complejos y formato de celdas
- `stringr`: Manipulaci칩n de cadenas de texto

## Resolviendo problemas comunes

Los desaf칤os m치s frecuentes al trabajar con hojas de c치lculo incluyen:

- Formatos de fecha inconsistentes
- Encabezados problem치ticos
- Disposiciones irregulares de datos
- Valores faltantes o inconsistentes
- Combinaci칩n de m칰ltiples fuentes

## Trabajando con fechas

Las fechas suelen causar confusi칩n al manejar hojas de c치lculo en R  
```{r}
#| eval: true
#| echo: true
library(readxl)
read_excel("hojs/fechasx.xlsx",sheet=2)

```

## 쯈u칠 pas칩?

. . .

Excel a veces guarda las fechas como n칰meros seriales contando el 1ro de enero de 1900 (o a veces 1904) como d칤a 0. Depende del formato de celda en el archivo de inter칠s.

## janitor 游뿪

Herramientas para limpiar tablas desordenadas.

```{r}
#| eval: true
#| echo: true

library(janitor)
excel_numeric_to_date(45573)
```

Las fechas tienen su propia clase en R y se pueden manejar con R base o con el paquete `lubridate`.

## Encabezados problem치ticos

Problemas comunes:  
- Espacios o caracteres especiales  
- M칰ltiples filas de encabezados  
- Nombres duplicados  
- Celdas combinadas

## Homogenizaci칩n de nombres de columnas

`clean_names()` de `janitor` nos ayuda a limpiar todos los nombres de las columnas
```{r}
#| eval: true
#| echo: true
# Limpiar nombres de columnas
library(janitor)
read_excel("hojs/gwater.xlsx") |> clean_names()

```


## Encabezados multi-fila

```{r}
#| eval: true
#| echo: true 
read_excel("hojs/encab.xlsx")
```

Se introducen NAs y aparecen fragmentos de encabezados en las filas que deber칤an contener datos.

## Soluci칩n con unheadr

`mash_colnames()` combina m칰ltiples filas de encabezados en nombres 칰nicos. Especificamos cu치ntas filas tienen fragmentos de encabezado.

```{r}
#| eval: true
#| echo: true
library(unheadr)
read_excel("hojs/encab.xlsx") |>
  mash_colnames(n_name_rows =  2)
```

## Valores faltantes

Por defecto -> celdas vac칤as o especificar con `na=` al momento de importar.
```{r}
#| eval: true
#| echo: true
read_excel("hojs/gwaterNA.xlsx")
```

##

```{r}
#| eval: true
#| echo: true
read_excel("hojs/gwaterNA.xlsx",na="FALTA")
```

A posteriori, podemos usar `na_if()` de `dplyr`

## Ejemplo real: Veterinaria

Archivo: `mascotas2.xlsx`  

Dos hojas, m칰ltiples problemas:  
- Encabezados multi-fila  
- Fechas en formatos inconsistentes  
- Valores faltantes  
- Informaci칩n guardada 칰nicamente en formato  
- Informaci칩n relacionada en las dos hojas  

## Ejemplo real: Veterinaria (continuaci칩n)

Funciones de `dplyr` para manejo de datos. Materiales 칰tiles [aqu칤](https://luisdva.github.io/R-biodiversidad-2025/materiales.html)  

* `mutate` para crear columnas nuevas  
* `str_detect` de stringr para buscar patrones en texto (detectar los indicadores de formato) 
* Funciones join para juntar tablas  


## Recursos 칰tiles

### Paquetes destacados

- `readxl` Importar desde Excel
- `googlesheets4`: Trabajo con Google Sheets
- `tidyxl`, `unpivotr`, `unheadr`: Manejo de hojas con formato 
- `janitor`: Limpieza de datos y nombres de columnas
- `lubridate`: Manejo de fechas
- `naniar`: An치lisis de datos faltantes

## Recursos 칰tiles (continuaci칩n)

### Documentaci칩n y tutoriales

- [R for Data Science (2e)](https://r4ds.hadley.nz/)
- [Documentaci칩n de readxl](https://readxl.tidyverse.org/)
- [Working with Spreadsheets, The Carpentries](https://datacarpentry.org/spreadsheets-socialsci/)

## Consejos finales

- Verificar siempre los datos importados (en Excel y en data frame)
- Documentar el procesamiento de datos
- Utilizar funciones para tareas repetitivas
- Crear flujos de trabajo reproducibles

## Discusi칩n

- 쯈u칠 desaf칤os espec칤ficos enfrentan con sus hojas de c치lculo?
- 쯈u칠 t칠cnicas han encontrado 칰tiles?
- 쮺칩mo podemos mejorar la colaboraci칩n entre usuarios de Excel y R?
- 쯈u칠 temas les gustar칤a explorar con m치s profundidad?

# 춰Gracias por participar!


